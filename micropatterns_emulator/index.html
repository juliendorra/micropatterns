<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPatterns Emulator</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/neat.css">
    <!-- CodeMirror show-hint addon CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            gap: 20px;
            padding: 10px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #displayCanvas {
            border: 1px solid black;
            image-rendering: pixelated;
            width: 200px;
            height: 200px;
        }

        textarea {
            width: 400px;
            height: 400px;
            font-family: monospace;
            font-size: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type=number] {
            width: 60px;
        }

        button {
            padding: 8px 15px;
            cursor: pointer;
        }

        #errorLog {
            color: red;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            margin-top: 10px;
        }

        .controls-group {
            border: 1px solid #eee;
            padding: 10px;
        }

        .controls-group h3 {
            margin-top: 0;
        }

        /* Style CodeMirror editor */
        .CodeMirror {
            border: 1px solid #ccc;
            height: 400px;
            /* Match original textarea height */
            font-family: monospace;
            font-size: 12px;
        }

        /* Basic Syntax Highlighting Styles (complementing the theme) */
        .cm-keyword {
            color: #708;
        }

        /* Magenta */
        .cm-variable-2 {
            color: #05a;
        }

        /* Blue for env vars */
        .cm-variable-3 {
            color: #085;
        }

        /* Teal for user vars */
        .cm-number {
            color: #164;
        }

        /* Dark blue/green */
        .cm-string {
            color: #a11;
        }

        /* Red */
        .cm-comment {
            color: #a80;
        }

        /* Orange/brown */
        .cm-operator {
            color: #c0c;
        }

        /* Purple */
        .cm-property {
            color: #30a;
        }

        /* Dark blue for param names */

        /* Asset Preview Styles */
        #assetPreviews canvas {
            border: 1px solid #ccc;
            image-rendering: pixelated;
            /* Keep pixels sharp */
            cursor: pointer;
            background-color: white;
            /* Ensure background for transparent pixels */
            margin-top: 5px;
        }

        #assetPreviews .asset-preview-item {
            margin-bottom: 10px;
        }

        #assetPreviews .asset-preview-item label {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 2px;
            display: block;
        }

        /* Drag and Drop Highlighting */
        #assetPreviews canvas.drop-target-active {
            outline: 2px dashed blue;
            outline-offset: -2px;
            background-color: #e0e0ff; /* Light blue background */
        }
    </style>
</head>

<body>
    <div class="column">
        <h2>MicroPatterns Script</h2>
        <textarea id="scriptInput" spellcheck="false">
# Welcome to MicroPatterns!
# Display is 200x200

# Define patterns using DEFINE PATTERN
DEFINE PATTERN NAME="checker" WIDTH=4 HEIGHT=4 DATA="1010010110100101"
DEFINE PATTERN NAME="smile" WIDTH=8 HEIGHT=8 DATA="0111111010000001101001011000000110100101100110011000000101111110"

# Declare variables used later
VAR center_x
VAR center_y
VAR bar_height
VAR rotation
VAR size

COLOR NAME=BLACK
# Use defined pattern name with FILL
FILL NAME="checker"
FILL_RECT X=0 Y=0 WIDTH=$WIDTH HEIGHT=$HEIGHT

COLOR NAME=WHITE
# Reset to solid fill
FILL NAME=SOLID
LET center_x = $WIDTH / 2
LET center_y = $HEIGHT / 2

# Use declared variables
TRANSLATE DX=$center_x DY=$center_y
# Expressions are only supported in assignements
LET rotation = 350 * 59 / $SECOND
ROTATE DEGREES=$rotation
LET size = $COUNTER % 20
SCALE FACTOR=$size
# Center the 8x8 pattern using DRAW
DRAW NAME="smile" X=-4 Y=-4

RESET_TRANSFORMS
COLOR NAME=BLACK
LET bar_height = $COUNTER % 50 + 10
# Use declared variable
FILL_RECT X=10 Y=180 WIDTH=30 HEIGHT=$bar_height 
        </textarea>
        <button id="runButton">Run Script</button>
        <div id="errorLog"></div>
    </div>

    <div class="column">
        <h2>Emulator Display</h2>
        <canvas id="displayCanvas" width="200" height="200"></canvas>

        <div class="controls-group">
            <h3>Environment</h3>
            <!-- Hour Row -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <label for="envHour" style="min-width: 60px; font-weight: bold;">Hour:</label>
                <span id="realTimeHourSpan" style="font-family: monospace; background-color: #eee; padding: 2px 4px; border-radius: 3px; min-width: 25px; text-align: right;">--</span>
                <input type="number" id="envHour" placeholder="Ovr" title="Override Hour (0-23)" min="0" max="23" style="width: 45px;">
            </div>
            <!-- Minute Row -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <label for="envMinute" style="min-width: 60px; font-weight: bold;">Minute:</label>
                <span id="realTimeMinuteSpan" style="font-family: monospace; background-color: #eee; padding: 2px 4px; border-radius: 3px; min-width: 25px; text-align: right;">--</span>
                <input type="number" id="envMinute" placeholder="Ovr" title="Override Minute (0-59)" min="0" max="59" style="width: 45px;">
            </div>
            <!-- Second Row -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <label for="envSecond" style="min-width: 60px; font-weight: bold;">Second:</label>
                <span id="realTimeSecondSpan" style="font-family: monospace; background-color: #eee; padding: 2px 4px; border-radius: 3px; min-width: 25px; text-align: right;">--</span>
                <input type="number" id="envSecond" placeholder="Ovr" title="Override Second (0-59)" min="0" max="59" style="width: 45px;">
            </div>
            <!-- Counter Row -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <label for="envCounter" style="min-width: 60px; font-weight: bold;">Counter:</label>
                <input type="number" id="envCounter" value="0" min="0" style="width: 60px;">
                <button id="resetCounterButton" title="Reset Counter" style="padding: 2px 8px;">â†º</button>
                <button id="incrementCounterButton" title="Increment Counter" style="padding: 2px 8px;">+</button>
            </div>
            <!-- Static Info -->
            <p style="font-size: 0.8em; margin-top: 10px; margin-bottom: 0; color: #555;">Display: 200x200</p>
        </div>

        <div class="controls-group">
            <h3>Patterns</h3>
            <p style="font-size: 0.8em; color: #555; margin-top: -5px; margin-bottom: 10px;">
                Click pixels to edit. Drag & drop an image onto a preview to import (resized, B&W threshold).
            </p>
            <div id="assetPreviews" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Previews will be generated here -->
                <p style="color: #777; font-style: italic;">No patterns defined or script not run yet.</p>
            </div>
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <!-- CodeMirror show-hint addon JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/anyword-hint.min.js"></script> <!-- Optional: provides basic word hinting -->
    <!-- MicroPatterns Mode for CodeMirror -->
    <script src="micropatterns-mode.js"></script>

    <script src="drawing.js"></script>
    <script src="parser.js"></script>
    <script src="runtime.js"></script>
    <script src="simulator.js"></script>
</body>

</html>